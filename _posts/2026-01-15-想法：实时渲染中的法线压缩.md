---
layout: post
title: 想法：实时渲染中的法线压缩
image: "/assets/images/main.png"
author: HaoNaN
---
# 想法：实时渲染中的法线压缩  
之前在某乎看到一篇文章，将某3A游戏中的延迟渲染的GBuffer中对法线的压缩算法，只记得前半部分法线贴图的利用率。  

## 法线贴图的利用率  
法线贴图在DCC软件中烘焙时，明显是讲法线向量归一化，然后讲XYZ三个分量分别从-1 - 1重映射到0 - 255，并将值写在上面。这也解释了为什么法线贴图的颜色总是那几个颜色，永远不会是纯黑、暗色或者纯白等颜色。此时就会法线，法线贴图在RGB贴图中的信息利用率非常低。具体多低，我们可以大致推算一下：
我们将RGB贴图的三个通道看作是3D空间中的XYZ轴，那么贴图的信息空间将是XYZ轴从-128到128组合成的256 * 256 * 256的空间内，即256 * 256 * 256个小方块。  
至于法线信息，一定是在物体表面上方，因此空间利用率首先砍掉一半，即（假设Y轴向上）256 * 128 * 256的上半块长方体内。  
其次，法线总是归一化后存储的，由于贴图通道精度问题，归一化后的法线向量的分量总是会去空间中寻找最近的小方块。那么，实际法线信息的可能覆盖的小方块，其实就是半径为128的半球面，与上述256 * 128 * 256的上半块长方体，相切的所有小方块。法线贴图信息的利用率即，这些小方块数量/(256 * 256 * 256)。
小方块的数量按照球面公式4 PI R2计算，R即128，计算出利用率竟然只有不到百分之二！（不过这样计算只是估算，球面与小方块相切是，球面并没有穿过每个小方块的中心，很大一部分可能只是擦到一个小角，这部分其实也应该算到，所以实际利用率应该是更高，具体的计算方法及结果，等大佬们来解答）  

## 尝试压缩  
这里的压缩方式，只考虑实时渲染中延迟渲染时的GBuffer中法线信息的压缩，以及各种Forward渲染中使用单独渲染的Normal Buffer信息的压缩。因为大部分DCC软件直出的法线图都已经是行业通用的存储成RGB的方法，且渲染逻辑大部分DCC软件也不太好改，就不考虑了。  
回到上面说的小方块，我的想法是，将法线信息存储为一个查找表，法线贴图中存储的是表的index，具体的法线向量值存储为常量。假设只用一个通道，8位的信息存储查找表，那么我们就要将256个不同的向量分布在这个半球面上，这样的利用率好像不太高，精度损失太严重。  
仔细观察数据会发现，半球在+-XZ四个区域，只是符号不同，数值相同，此时我们可以将查找表中的数据量缩减到四分之一，这样我们在一个扇区就能够存储256个向量，一个半球即1024个向量。  
计算一下原来相切小方块的数量，大致是102891（正确性待定），如果使用查找表的方法来达到这个量级，需要大致16-17位信息的存储量，两个贴图通道。这种方法貌似和只存储两个分量的法线算法没啥区别。但是，这个灵活在，我可以随时调整法线的精度，我可以在Buffer中根据需求将其压缩到任意精度，Normal Buffer的使用大多都是AO等对精度要求并没有那么高的后处理效果，或许可以接受？  

以上只是想法，并没有实际测试。等哪天有空了再说吧。
